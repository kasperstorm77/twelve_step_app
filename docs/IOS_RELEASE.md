# iOS Release Build Guide

## Prerequisites

1. **Apple Developer Account** ($99/year)
   - Enroll at https://developer.apple.com/programs/
   
2. **App Store Connect** app created
   - Go to https://appstoreconnect.apple.com
   - Create new app

3. **Xcode** installed on macOS
   - Required for code signing and submission

---

## Step 1: Configure Bundle Identifier

The default bundle ID is `com.example.twelvestepsapp` - you should change this to your own.

**Option A: Via Xcode (Recommended)**
1. Open `ios/Runner.xcworkspace` in Xcode (NOT `.xcodeproj`)
2. Select "Runner" in the project navigator
3. Under "Signing & Capabilities" tab:
   - Change Bundle Identifier to your own (e.g., `dk.stormstyrken.twelvestepsapp`)
   - Select your Team
   - Xcode will automatically manage signing

**Option B: Via Command Line**
Edit `ios/Runner.xcodeproj/project.pbxproj` and search for `PRODUCT_BUNDLE_IDENTIFIER`, update all occurrences.

---

## Step 2: Update iOS OAuth Client in Google Cloud Console

⚠️ **CRITICAL:** When you change the bundle ID, you MUST update the iOS OAuth client!

1. Go to https://console.cloud.google.com/apis/credentials?project=mobile-app-drive-sync
2. Find the iOS OAuth client: `628217349107-2u1kqe686mqd9a2mncfs4hr9sgmq4f9k`
3. Update the Bundle ID to match your new bundle identifier
4. Save changes

**Then update the URL scheme in Info.plist:**
- The URL scheme format: `com.googleusercontent.apps.<your-ios-client-id-without-.apps.googleusercontent.com>`
- Example: If client ID is `628217349107-2u1kqe686mqd9a2mncfs4hr9sgmq4f9k.apps.googleusercontent.com`
- URL scheme is: `com.googleusercontent.apps.628217349107-2u1kqe686mqd9a2mncfs4hr9sgmq4f9k`

---

## Step 3: Configure App Icons and Metadata

**App Display Name:**
Edit `ios/Runner/Info.plist`:
```xml
<key>CFBundleDisplayName</key>
<string>12 Steps App</string>
```

**App Icons:**
- Icons are automatically generated by `flutter_launcher_icons`
- Located in `ios/Runner/Assets.xcassets/AppIcon.appiconset/`
- Source: `icon.png` in project root

**Version Numbers:**
- Version managed in `pubspec.yaml`: `version: 1.0.1+37`
- Format: `MAJOR.MINOR.PATCH+BUILD_NUMBER`
- Increment with: `dart scripts/increment_version.dart`

---

## Step 4: Build Release IPA

**Method 1: Using Flutter Command (Recommended)**
```bash
# Increment version first
dart scripts/increment_version.dart

# Build release IPA
flutter build ipa --release

# Output: build/ios/ipa/twelvestepsapp.ipa
```

**Method 2: Using Xcode**
1. Open `ios/Runner.xcworkspace` in Xcode
2. Select "Any iOS Device (arm64)" as destination
3. Product → Archive
4. Once archived, click "Distribute App"
5. Choose "App Store Connect"
6. Follow the wizard to upload

---

## Step 5: Upload to App Store Connect

**Via Xcode (After Archive):**
- In Organizer window, select your archive
- Click "Distribute App"
- Choose "App Store Connect"
- Select automatic signing
- Upload

**Via Transporter App:**
1. Download "Transporter" from Mac App Store
2. Open the `.ipa` file from `build/ios/ipa/`
3. Click "Deliver"

**Via Command Line (Advanced):**
```bash
# Using xcrun altool (deprecated)
xcrun altool --upload-app --type ios --file build/ios/ipa/twelvestepsapp.ipa \
  --username "your@email.com" --password "app-specific-password"

# Or using xcrun notarytool (newer)
xcrun notarytool submit build/ios/ipa/twelvestepsapp.ipa \
  --apple-id "your@email.com" --password "app-specific-password" \
  --team-id "YOUR_TEAM_ID"
```

---

## Step 6: Submit for Review

1. Go to App Store Connect
2. Navigate to your app
3. Create a new version (if needed)
4. Fill in all required metadata:
   - App Description
   - Keywords
   - Screenshots (required for all device types)
   - Privacy Policy URL
   - Support URL
5. Select the build you uploaded
6. Submit for Review

---

## Common Issues

### "No identity found" error
→ You need to configure code signing in Xcode with your Apple Developer account

### "Bundle identifier mismatch"
→ Make sure the bundle ID in Xcode matches what you configured in App Store Connect

### "Missing iOS Distribution certificate"
→ Create one in Apple Developer Portal under Certificates, IDs & Profiles

### "Google Sign-In not working after bundle ID change"
→ Update the iOS OAuth client in Google Cloud Console with new bundle ID
→ Update the URL scheme in Info.plist

### "Version already exists"
→ Increment version with `dart scripts/increment_version.dart`
→ Or manually update `pubspec.yaml`

---

## iOS Release Checklist

Before submitting:

- [ ] Updated bundle identifier from `com.example.twelvestepsapp`
- [ ] Updated iOS OAuth client in Google Cloud Console with new bundle ID
- [ ] Updated URL scheme in Info.plist
- [ ] Configured code signing in Xcode
- [ ] Set proper app display name
- [ ] Incremented version number
- [ ] Tested on real iOS device
- [ ] Verified Google Sign-In works
- [ ] Verified Drive sync works
- [ ] All app features tested
- [ ] Screenshots prepared for all device types
- [ ] Privacy Policy URL ready
- [ ] Support URL ready

---

## Current Configuration

**Bundle ID:** `com.example.twelvestepsapp` (⚠️ Change this!)  
**iOS OAuth Client:** `628217349107-2u1kqe686mqd9a2mncfs4hr9sgmq4f9k.apps.googleusercontent.com`  
**URL Scheme:** `com.googleusercontent.apps.628217349107-2u1kqe686mqd9a2mncfs4hr9sgmq4f9k`  
**Current Version:** Check `pubspec.yaml`  
**App Display Name:** "Twelvestepsapp" (⚠️ Update to "12 Steps App")

---

## Resources

- [Flutter iOS Deployment Guide](https://docs.flutter.dev/deployment/ios)
- [Apple Developer Portal](https://developer.apple.com)
- [App Store Connect](https://appstoreconnect.apple.com)
- [App Store Review Guidelines](https://developer.apple.com/app-store/review/guidelines/)
